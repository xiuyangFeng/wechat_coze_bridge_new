

### **项目开发需求：基于微信云托管的公众号内容同步服务 (V4.0)**

#### **1. 项目概述 (Executive Summary)**

**目标**：将现有的Webhook服务重构并迁移至**微信云托管**平台。新架构将利用云托管的事件订阅能力，在**不启用公众号“服务器配置”**的前提下，实现公众号新发布内容的自动化同步。这将完美解决“启用服务器配置会导致自定义菜单等后台功能失效”的核心痛点。

**核心架构变更**：
*   **部署平台**: 从 Vercel (或任何公网服务器) 迁移至 **微信云托管**。
*   **触发方式**: 从公网 `Webhook` (需要URL验证) 变更为云托管**内部事件订阅** (免鉴权)。
*   **公众号后台**: **无需启用**“服务器配置”，保持默认的“编辑模式”，所有现有功能（自定义菜单、自动回复等）**不受任何影响**。

**最终效果**: 实现一个与公众号后台运营功能完全解耦、安全、免运维的自动化内容同步管道。

#### **2. 核心工作流程 (Core Workflow - V4.0)**

1.  **触发**: 微信公众号成功发布一篇新文章。
2.  **事件订阅与推送**: 微信后台通过**内部服务**，将 `PUBLISHJOBFINISH` 事件的XML数据，直接 `POST` 到您部署在微信云托管上的服务指定路径（通常是 `/`）。
3.  **服务接收与处理**:
    *   云托管服务接收到不含任何签名验证的、纯净的XML `POST` 请求。
    *   服务解析XML，获取文章的标题和URL。
    *   服务访问文章URL，抓取完整HTML内容。
    *   **双通道处理逻辑 (与V3.0完全相同)**:
        *   **通道一**: 将文章URL、标题、摘要写入Coze的“文章-增量库”。
        *   **通道二**: 提取文章内的文献链接，并将文献标题、链接写入Coze的“文献-增量库”。
4.  **响应**: 服务向云托管环境返回一个 `HTTP 200 OK` 响应，表示处理成功。

---

#### **3. 技术栈与环境要求 (Technical Requirements)**

*   **编程语言**: Python 3.9+
*   **Web框架**: Flask (或其他轻量级框架)
*   **部署环境**: **微信云托管** (基于Docker容器)
*   **核心依赖库**: `flask`, `requests`, `beautifulsoup4`, `lxml`, `gunicorn` (用于生产环境运行)

---

#### **4. 功能详细分解 (Functional Breakdown)**

##### **4.1. 服务入口与代码结构调整 (`index.py` 或 `main.py`)**

**这是本次重构的核心。**

*   **移除微信签名验证**:
    *   **必须删除**所有处理 `GET` 请求的代码块 (`if request.method == 'GET'`)。
    *   **必须删除**所有与 `signature`, `timestamp`, `nonce`, `echostr` 相关的变量和`sha1`加密验证逻辑。云托管环境不再需要这些。

*   **简化主路由**:
    *   主路由应监听根路径 `/`，并且只处理 `POST` 请求。
    *   代码结构应简化为如下形式：
        ```python
        from flask import Flask, request
        
        app = Flask(__name__)

        @app.route('/', methods=['POST'])
        def handle_event():
            # 1. 直接从 request.data 获取原始XML
            xml_data = request.data
            
            # 2. 在这里直接开始解析XML和处理业务逻辑
            #    (将之前 webhook POST 部分的 try...except 块整体移入)
            try:
                root = ET.fromstring(xml_data)
                # ... 后续逻辑与V3.0完全相同 ...
            except Exception as e:
                logging.error(f"处理事件时发生异常: {e}")
            
            # 3. 无论成功与否，都返回一个简单的成功响应
            return "OK", 200
        ```

*   **保留核心业务逻辑**:
    *   `create_coze_doc()` 函数 **保持不变**。
    *   `sync_article_to_hot_kb()` 函数 **保持不变**。
    *   `sync_references_to_hot_kb()` 函数 **保持不变**。

##### **4.2. 容器化配置 (`Dockerfile`)**

为了在云托管上运行，项目需要一个 `Dockerfile` 来定义容器环境。

*   在项目**根目录**下创建一个名为 `Dockerfile` (无后缀) 的文件。
*   文件内容应如下：
    ```dockerfile
    # 使用官方的 Python 3.9 slim 镜像作为基础
    FROM python:3.9-slim

    # 设置工作目录
    WORKDIR /app

    # 复制依赖文件并安装依赖
    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt

    # 复制所有应用代码到工作目录
    COPY . .

    # 暴露 Flask 应用运行的端口 (云托管通常使用 80)
    EXPOSE 80

    # 容器启动时执行的命令
    # 使用 gunicorn 作为生产级的 WSGI 服务器来运行 Flask 应用
    # 'main:app' 指的是运行 main.py 文件中的 app 实例
    CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:80", "main:app"]
    ```
    *注意：如果您的主文件名是 `index.py`，则最后一行命令应改为 `main:app`。为保持一致性，建议将主文件命名为`main.py`。*

##### **4.3. 依赖文件 (`requirements.txt`)**

文件内容需要更新，移除 `python-dotenv` 并加入 `gunicorn`。
```
flask
requests
beautifulsoup4
lxml
gunicorn
```

##### **4.4. 配置文件 (`config.py` - 可选但推荐)**

为了代码整洁，可以将环境变量的加载逻辑放入一个单独的文件。

*   `config.py`:
    ```python
    import os

    COZE_API_KEY = os.getenv('COZE_API_KEY')
    KB_ID_ARTICLES_HOT = os.getenv('KB_ID_ARTICLES_HOT')
    KB_ID_REFERENCES_HOT = os.getenv('KB_ID_REFERENCES_HOT')
    ```
*   在 `main.py` 中，通过 `from config import COZE_API_KEY, ...` 来导入。

---

#### **5. 微信云托管平台配置步骤**

1.  **服务创建与部署**:
    *   在微信云托管控制台，选择“新建服务”。
    *   选择“代码库拉取”，并授权访问您的代码仓库（如GitHub）。
    *   配置端口为 `80`。
    *   在“高级配置”的“环境变量”中，添加以下三个变量：
        *   `COZE_API_KEY`
        *   `KB_ID_ARTICLES_HOT`
        *   `KB_ID_REFERENCES_HOT`
    *   触发部署。

2.  **配置微信接收设置 (关键)**:
    *   服务部署成功后，在云托管控制台进入该服务的“服务设置”或“微信接收设置”。
    *   **消息推送格式**: 选择 `XML`。
    *   **接口路径**: 填入 `/`。
    *   **事件订阅**: 点击“添加”，在弹出的事件列表中，找到并勾选 `PUBLISHJOBFINISHEVENT`。
    *   保存配置。

---

#### **6. 验收标准 (Acceptance Criteria)**

1.  **部署验收**: 服务成功在微信云托管平台部署，无启动错误。
2.  **配置验收**:
    *   公众号后台的“服务器配置”**保持未启用状态**。
    *   自定义菜单等功能在手机端访问时，**正常可用**。
3.  **功能验收**:
    *   在公众号后台**草稿箱**中，选择一篇包含若干文献链接的文章，执行“发布”操作。
    *   发布成功后，等待1-2分钟。
    *   登录Coze平台，检查“文章-增量库”和“文献-增量库”，应能看到对应的新文档被成功创建。
4.  **日志验收**: 在微信云托管的“日志”页面，应能看到服务接收到事件并成功处理的日志记录，无严重错误。