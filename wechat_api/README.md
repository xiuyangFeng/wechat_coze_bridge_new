# 微信公众号内容同步 Coze 知识库服务

## 1. 项目概述

本项目是一个基于 Python Flask 的 Web 服务，旨在自动化地将微信公众号新发布的文章及其引用的参考文献，同步到指定的 Coze 知识库中。

该服务专门为 **微信云托管** 环境设计，通过订阅微信后台的事件（`MASSSENDJOBFINISH`）来触发同步流程。其最大的优势在于 **无需在公众号后台启用“服务器配置”**，从而避免了与自定义菜单、自动回复等现有后台功能的冲突，实现了与公众号日常运营的完全解耦。

## 2. 核心功能

- **自动化同步**：公众号文章一旦成功群发，服务将自动触发，无需人工干预。
- **双通道处理**：
    1.  **文章通道**：提取文章的标题、URL和摘要，存入“文章热点库”。
    2.  **文献通道**：解析文章内容，提取所有参考文献的标题和链接，存入“文献热点库”。
- **无缝集成**：专为微信云托管优化，利用其内部事件订阅机制，安全高效。
- **兼容性强**：不影响公众号后台的任何标准功能（如自定义菜单、消息回复等）。
- **容器化部署**：提供 `Dockerfile`，支持快速、标准化的容器部署。
- **日志完备**：集成了详细的日志记录，方便追踪和调试。
- **模块化测试**：包含单元测试和集成测试 (`test_main.py`)，确保代码质量。

## 3. 技术栈

- **后端框架**: Flask
- **WSGI 服务器**: Gunicorn
- **HTTP 请求**: Requests
- **HTML 解析**: BeautifulSoup4, lxml
- **编程语言**: Python 3.9
- **部署环境**: Docker, 微信云托管

## 4. 工作流程

1.  **触发**：在微信公众号后台成功群发一篇文章。
2.  **事件推送**：微信后台通过内部服务，将 `MASSSENDJOBFINISH` 事件的 XML 数据 `POST` 到部署在云托管上的本服务。
3.  **服务处理**：
    - Flask 应用接收到 XML 数据。
    - 解析 XML，提取文章标题和 HTML 内容。
    - **文章同步**：调用 `sync_article_to_hot_kb` 函数，提取文章摘要，并连同标题、URL一起上传到 Coze 的“文章知识库”。
    - **文献同步**：调用 `sync_references_to_hot_kb` 函数，提取文内所有参考文献，逐条上传到 Coze 的“文献知识库”。
4.  **响应**：服务向微信后台返回 `HTTP 200 OK`，表示处理完毕。

## 5. 安装与部署指南

本项目推荐部署在 **微信云托管** 平台。

### 5.1. 环境变量配置

在部署前，您需要在云托管服务的环境变量设置中配置以下三个密钥：

| 变量名                 | 说明                                   | 示例值                                       |
| ---------------------- | -------------------------------------- | -------------------------------------------- |
| `COZE_API_KEY`         | 您在 Coze 平台申请的 API Key。         | `pat_xxxxxxxxxxxxxxxxxxxxxxxx`               |
| `KB_ID_ARTICLES_HOT`   | 用于存储文章摘要的 Coze 知识库 ID。    | `7554764213966192681`                        |
| `KB_ID_REFERENCES_HOT` | 用于存储参考文献链接的 Coze 知识库 ID。 | `7554782522942849064`                        |

您也可以在本地创建一个 `.env` 文件用于开发和测试，格式如下：

```env
COZE_API_KEY=your_coze_api_key
KB_ID_ARTICLES_HOT=your_article_kb_id
KB_ID_REFERENCES_HOT=your_reference_kb_id
```

### 5.2. 微信云托管部署步骤

1.  **创建服务**：在微信云托管控制台，新建一个服务。
2.  **代码部署**：选择“从代码库拉取”，并授权访问包含本项目的代码仓库。
3.  **服务配置**：
    - **端口**：设置为 `80`。
    - **环境变量**：根据 `5.1.` 章节，添加上述三个环境变量。
4.  **触发部署**：启动部署流程，云托管将根据 `Dockerfile` 自动构建和部署服务。
5.  **配置微信接收设置 (关键)**：
    - 服务部署成功后，进入该服务的“微信接收设置”页面。
    - **消息推送格式**：选择 `XML`。
    - **接口路径**：填入 `/`。
    - **事件订阅**：点击“添加”，找到并勾选 `MASSSENDJOBFINISH` 事件。
    - 保存配置。

## 6. 使用与测试

### 6.1. 自动触发

服务部署并正确配置后，您只需在微信公众号后台正常发布文章即可自动触发同步。处理结果可以在云托管的“日志”页面查看。

### 6.2. 本地单元测试

项目包含一个全面的测试套件 `test_main.py`，覆盖了数据提取、Coze API 调用和 Flask 端点等核心逻辑。

在项目根目录下运行以下命令来执行测试：

```bash
python -m unittest discover -s . -p 'test_main.py'
```

### 6.3. Coze API 上传测试

项目提供了一个独立的脚本 `coze_file_uploader.py`，用于测试文件直接上传到 Coze 知识库的功能。这对于验证您的 `COZE_API_KEY` 和 `TARGET_KB_ID` 是否有效非常有用。

使用前，请确保 `.env` 文件存在且已配置好 `COZE_API_KEY` 和 `TARGET_KB_ID` (此脚本使用 `TARGET_KB_ID`，您可以将其设置为您的文章库或文献库ID进行测试)。

然后运行脚本：

```bash
python coze_file_uploader.py
