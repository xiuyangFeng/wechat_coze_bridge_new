
### **项目开发需求：微信公众号内容双通道精准同步至Coze多知识库服务 (V2.0)**

#### **1. 项目概述 (Executive Summary)**

**目标**：创建一个高精度的自动化Web服务，用于实时同步微信公众号的新发布内容。该服务需实现双通道数据处理：
1.  **通道一**：将新发布文章的**URL、标题、摘要**同步至“**公众号文章URL知识库**”。
2.  **通道二**：智能提取文章内嵌的特定文献链接，并将文献的**标题和链接**同步至“**文献原文链接知识库**”。

**最终效果**：实现两种不同类型知识的自动化、结构化归档，为Coze智能体的多源信息检索提供实时、精准的数据支持。

#### **2. 核心工作流程 (Core Workflow)**

1.  **触发与接收**：服务通过Webhook接收微信公众号新文章发布的通知。
2.  **文章信息解析**：服务解析通知，获取文章的**标题 (Title)** 和**原始URL (Article URL)**。
3.  **内容抓取与分析**：服务访问文章URL，抓取完整HTML内容，并进行以下分析：
    *   **提取摘要 (Snippet)**：从HTML中提取文章开头的摘要部分（通常是前100-150个字符）。
    *   **提取文献信息 (Reference Info)**：使用正则表达式 `https://s\.caixuan\.cc/[A-Za-z0-9]+` 查找所有匹配的文献链接，并从链接前的文本中提取**文献标题**。
4.  **双通道数据上传**：
    *   **通道一 (公众号文章)**: 调用Coze API，将**文章URL、文章标题、文章摘要**作为一个数据单元，上传到“公众号文章URL知识库”。
    *   **通道二 (文献链接)**: 遍历所有提取到的文献信息，调用Coze API，将每一个**文献标题**和**文献链接**作为一个数据单元，上传到“文献原文链接知识库”。
5.  **响应**：服务向微信服务器回复"success"。

#### **3. 技术栈与环境要求 (Technical Requirements)**

*   **编程语言**: Python (版本 3.9 或更高)
*   **Web框架**: Flask
*   **依赖库**: `requests`, `beautifulsoup4`, `lxml`
*   **部署环境**: **Vercel** 无服务器平台。

#### **4. 功能详细分解 (Functional Breakdown)**

##### **4.1 API 端点与微信验证**

*   **路径**: `/api/webhook` (支持 `GET` 和 `POST`)
*   **功能**: 与上一版需求完全相同，用于处理微信服务器的URL验证和接收文章发布通知。

##### **4.2 内容处理核心模块**

*   在接收到POST请求并确认为 `PUBLISHJOBFINISH` 事件后触发。
*   **输入**: 微信推送XML中的文章标题 (`article_title`) 和文章URL (`article_url`)。
*   **处理逻辑**:
    1.  **抓取HTML**：使用 `requests` 获取 `article_url` 的完整HTML。
    2.  **创建BeautifulSoup对象**：`soup = BeautifulSoup(html_content, 'lxml')`。
    3.  **启动通道一**：调用 **公众号文章同步模块**，传入 `article_title`, `article_url`, 和 `soup` 对象。
    4.  **启动通道二**：调用 **文献链接同步模块**，传入 `soup` 对象。

##### **4.3 通道一：公众号文章同步模块 (Article Sync Module)**

*   **输入**: `article_title`, `article_url`, `soup` 对象。
*   **数据准备**:
    1.  **提取摘要 (`snippet`)**:
        *   定位到文章正文容器 `div#js_content`。
        *   获取其纯文本内容 `plain_text = content_div.get_text(strip=True)`。
        *   截取前150个字符作为摘要: `snippet = plain_text[:150]`。
    2.  **构造上传内容 (`content_for_kb`)**: 创建一个结构化的字符串，**模拟知识库中的一行数据**。**格式至关重要**，必须包含三个核心字段，并用特殊的分隔符（如`|||`）隔开：
        `content_for_kb = f"{article_url}|||{article_title}|||{snippet}"`
*   **API调用**:
    1.  从环境变量中获取 `COZE_API_KEY` 和 `KB_ID_ARTICLES`。
    2.  调用Coze `doc_create` API。
    3.  **请求体 (JSON Payload)**:
        ```json
        {
          "kb_id": "YOUR_KB_ID_ARTICLES",
          "doc_name": article_title, // 文档名可以是文章标题
          "doc_type": "text",
          "content": content_for_kb // 将结构化字符串作为内容上传
        }
        ```
    4.  记录上传结果日志。

##### **4.4 通道二：文献链接同步模块 (Reference Sync Module)**

*   **输入**: `soup` 对象。
*   **数据准备**:
    1.  **提取所有文献链接 (`links`)**:
        *   将 `soup` 对象转为字符串。
        *   使用 `re.findall(r'https://s\.caixuan\.cc/[A-Za-z0-9]+', html_string)` 提取所有链接。
        *   去重并过滤无效链接。
    2.  **如果未找到链接**，记录日志并直接返回。
    3.  **遍历每一个找到的链接 (`ref_link`)**:
        *   **提取文献标题 (`ref_title`)**: 这是一个关键步骤。需要在HTML中**定位到这个链接(`<a>`标签)**，然后**向前查找**其关联的文本作为标题。
            *   **策略1（推荐）**：使用 `soup.find_all('a', href=ref_link)` 找到所有包含该链接的 `<a>` 标签。
            *   **策略2**：对于每个 `<a>` 标签，向上查找其父节点（如 `<p>`, `<li>`），获取该节点的完整文本，并清理掉多余的字符（如 "来源文章：" 等）。这个文本就是文献标题。
        *   **构造上传内容 (`content_for_kb`)**: 同样创建结构化字符串：
            `content_for_kb = f"{ref_title}|||{ref_link}"`
*   **API调用 (在循环内)**:
    1.  从环境变量中获取 `COZE_API_KEY` 和 `KB_ID_REFERENCES`。
    2.  为**每一个**文献信息单元调用Coze `doc_create` API。
    3.  **请求体 (JSON Payload)**:
        ```json
        {
          "kb_id": "YOUR_KB_ID_REFERENCES",
          "doc_name": ref_title, // 文档名可以是文献标题
          "doc_type": "text",
          "content": content_for_kb
        }
        ```
    4.  记录每一次上传的结果日志。

#### **5. 配置与安全性 (Configuration & Security)**

*   **环境变量**: 需要定义以下**四个**环境变量：
    1.  `WECHAT_TOKEN`: 微信令牌。
    2.  `COZE_API_KEY`: Coze个人访问令牌。
    3.  `KB_ID_ARTICLES`: **公众号文章URL知识库**的ID。
    4.  `KB_ID_REFERENCES`: **文献原文链接知识库**的ID。

#### **6. 错误处理与日志 (Error Handling & Logging)**

*   需要清晰的日志来区分两个通道的处理过程。
*   在提取文献标题时，如果无法定位或提取失败，应记录详细的错误信息，并跳过该链接的处理，继续处理下一个。

#### **7. 部署要求 (Deployment Requirements)**

*   与上一版需求相同，需要 `api/index.py` 和 `requirements.txt`。

#### **8. 验收标准 (Acceptance Criteria)**

1.  服务成功部署并通过微信后台验证。
2.  发布一篇**包含3个不同文献链接**的公众号文章后：
    *   **验收点A**: “公众号文章URL知识库”中**新增1条**记录，包含该文章的URL、标题和摘要。
    *   **验收点B**: “文献原文链接知识库”中**新增3条**记录，每一条分别对应一个文献的标题和链接。
3.  发布一篇**不包含任何文献链接**的公众号文章后：
    *   **验收点C**: “公众号文章URL知识库”中**新增1条**记录。
    *   **验收点D**: “文献原文链接知识库”中**没有**新增任何记录。
4.  所有密钥和ID均通过环境变量配置。

---
